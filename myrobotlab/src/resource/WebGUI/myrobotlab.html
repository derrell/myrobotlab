<!doctype html>
<html lang="en">
<head>
<!-- 
	References : 
	  http://msdn.microsoft.com/en-us/library/ie/hh673567(v=vs.85).aspx - excellent examples - sendBinaryMessage
	  http://stackoverflow.com/questions/456177/function-overloading-in-javascript-best-practices
	  http://stackoverflow.com/questions/5112793/how-do-i-dynamically-call-a-javascript-objects-method
	  http://stackoverflow.com/questions/2141520/javascript-variable-number-of-arguments-to-function
	  http://stackoverflow.com/questions/5723289/jquery-ui-accordion-in-accordion (nested accordion)
	  http://stackoverflow.com/questions/1098040/checking-if-an-associative-array-key-exists-in-javascript
	  http://stackoverflow.com/questions/912711/jquery-to-load-javascript-file-dynamically
	  http://stackoverflow.com/questions/8277462/jquery-append-external-html-file-into-my-page
	  http://stackoverflow.com/questions/500431/javascript-variable-scope (scope !)
	  
	  TODO :
 -->
<meta charset="utf-8" />
<title>myrobotlab - One Software To Rule Them All !</title>
<link rel="stylesheet" href="common/themes/vader/jquery-ui.css" />
<link rel="stylesheet" href="common/style.css">
<script src="common/js/jquery-1.10.2.min.js"></script>
<script src="common/js/jquery-ui.min.1.10.3.js"></script>
<script src="common/js/jquery.websocket-0.0.1.js"></script>
<script src="common/js/jquery.json-2.2.min.js"></script>
<script>
	// global registry and vars
	var registry = [];
	var guiMapByIndex = [];
	var guiMapByName = new Array();
	var loadedClasses = [];
	var connection; // the one and only connection (at the moment - 1 per environment/host)
	var debug = true;
	var clockGUI;

	function Message(name, method, params) {
		this.msgID = new Date().getTime();
		this.timeStamp = this.msgID;
		this.name = name;
		this.sender = "webgui"; // FIXME - named passed in
		this.sendingMethod = "";
		this.historyList = new Array(); // necessary?
		this.method = method;
		this.data = params;
	}

	var wsURI = "ws://localhost:7778"; // TODO - this gets passed up from server
	var boundServiceName = "clock";
	
	function getSimpleClassName(inName)
	{
		return inName.substring(inName.lastIndexOf(".")+1);
	}

	function Connection(uri) {
		this.ws = new WebSocket(uri);

		this.ws.onopen = function(openEvent) {
			$("#topMessage").text("connected to ...");
		};

		this.ws.onerror = function(errorMsg) {
			error("WebSocket Error " + errorMsg);
		};

		this.ws.onmessage = function(e) {
			info("Server: " + e.data);

			try {
				var msg = jQuery.parseJSON(e.data);
				info("invoke " + msg.sender + "." + msg.method);
				if (msg.method == "getRegistry") {
					getRegistry(msg.data)
				} else {
					registry[msg.sender][msg.method](msg.data);
				}
			} catch (err) {
				//alert("json parse error " + err + " data " + e.data);
				//error("json parse error " + err + " data " + e.data);
				error(err); // make not all exceptions will be trapped
			}
		};
	}

	// global getRegistry -
	// CAREFUL any vars in here are global too !
	function getRegistry(data) {
		
		var inRegistry = data[0];
		loadServiceGUIClass(inRegistry, Object.keys(inRegistry), 0);
	}

	function loadServiceGUIClass(inRegistry, nameArray, index) {

		// check  to see if we are done
		if (index == Object.keys(inRegistry).length){
			return;
		}
		
		var serviceName = nameArray[index];
		var serviceWrapper = inRegistry[serviceName];
		var className = getSimpleClassName(serviceWrapper.service.serviceClass);

		
		// if this is a new class - we will load it
		if (!(className in loadedClasses)){
			
		
		// get runs on a different thread - or at least the callback does
		// so this can't be in a for loop indexed by name - it has to be
		// in a recursive driven method
		$.get("/resource/WebGUI/"+className+".html",
				function(data, result, scopedName) {
					// load the accordian reference 
					$("<h3><img src='/resource/" + className + ".png' /> " + serviceName + "</h3>" ).appendTo( "#accordion1" );
					$("<div id='" + serviceName + "-gui'>" + serviceName + "</div>" ).appendTo( "#accordion1" );
					$("#accordion1").accordion("refresh");
					
					// load the new service class
					$("#" + serviceName + "-gui").html(data); // FIXME - all service gui elements must have unique IDs !
					newClass = " new " + className + "GUI('"+name+"');";
					guiMapByName[name] = eval(newClass);
					alert(guiMapByName[name]);
					guiMapByName[name].init();
					guiMapByName[name].attachGUI();
// FIXME	recurse				loadServiceGUIClass(, index + 1);
				});

		} else if (!(name in guiMapByName)) {
			// class is loaded - but need a new instance
		}
		
	}


	// --- ServiceGUI begin ----
	// FIXME - you need both the boundServiceName && webui name !
	function ServiceGUI(name) {
		this.name = name;
	}

	ServiceGUI.prototype.attachGUI = function() {
	};

	ServiceGUI.prototype.dettachGUI = function() {
	};

	// send to bound service name
	ServiceGUI.prototype.send = function(method, data) {
		var msg = new Message(this.name, method, data);
		var json = JSON.stringify(msg);
		connection.ws.send(json);
	};

	ServiceGUI.prototype.sendTo = function(name, method, data) {
		var msg = new Message(name, method, data);
		var json = JSON.stringify(msg);
		connection.ws.send(json);
	};

	ServiceGUI.prototype.subscribe = function(inMethod, outMethod) //(inMethod, outMethod, params)
	{
		this.sendTo("webgui", "subscribe", [ boundServiceName, inMethod,
				outMethod ]);
	}

	ServiceGUI.prototype.subscribeTo = function(publisherName, outMethod,
			inMethod) //(inMethod, outMethod, params)
	{
		// FIXME - need a "subscribe to a runtimes' getRegistry"
		this.sendTo("webgui", "subscribe",
				[ publisherName, inMethod, outMethod ]);
	}

	// --- ServiceGUI end ----

	
	// hmmm One ServiceGUI to Rule them All ?!?!?
	var mrl = new ServiceGUI("runtime");

	// -- webgui framework display begin ---
	$(function() {
		$("#accordion1").accordion({
			//collapsible: true,
			autoHeight : false,
			active : false
		});

		$("#accordion2").accordion({
			header : "h3",
			active : false,
			collapsible : true,
			heightStyle : "content"
		});
	});
	// -- webgui framework display begin ---

	// -- websocket global connectivity and message processing begin --
	// TODO - jquery best practices - anonymous functions are to be avoided

	$(function() {
		$("#subscribeToRegistry").button().click(function(event) {
			mrl.subscribeTo("runtime", "getRegistry", "getRegistry");
		});
	});

	$(function() {
		$("#getRegistry").button().click(function(event) {
			mrl.sendTo("runtime", "getRegistry");
		});
	});

	$(function() {
		$("#load").button().click(function(event) {

			$.get("load.html", function(data) {
				// $(this).children("div:first").html(data);
				$("#insert").html(data);
			});

			/*
			$.getScript("load.js", function() {
			    //TinyMCE.init(); <--- Oooo can init with "name"
			});
			 */
		});
	});

	// --- logging begin ----
	function debug(text) {
		log(text, "debug");
	}

	function info(text) {
		log(text, "info");
	}

	function warn(text) {
		log(text, "warn");
	}

	function error(text) {
		log(text, "error");
	}

	// http://stackoverflow.com/questions/456177/function-overloading-in-javascript-best-practices
	function log(text, level) {
		//$("#log").val((text !== null ? text : "null") + "\n" + $("#log").val());
		$("#log").html(
				"<span class='"+level+"'>" + level + " " + text
						+ "</span><br />" + $("#log").html());
		/*
		$("#log").val(
				(new Date).getTime() + ": " + (text !== null ? text : "null")
						+ "\n" + $("#log").val());
		 */
	}
	// --- logging end ----

	// DOM loaded
	$(document).ready(function() {

		$("#topMessage").html("connecting to ...");

		// start the connection process
		connection = new Connection(wsURI);
		/*
		$("#load").click(function() {
		    //if(typeof TinyMCE == "undefined") {
		        $.getScript("load.js", function() {
		            //TinyMCE.init(); <--- Oooo can init with "name"
		        });
		    //}
		});
		 */
	});
</script>

</head>
<body>
	<div id="accordion1">
		<h3>
			<img src="../myrobotlab.png" />myrobotlab <span id="topMessage"></span>
		</h3>
		<div>
			<button id="subscribeToRegistry">subscribeToRegistry</button>
			<button id="getRegistry">getRegistry</button>
			<button id="load">load</button>
			<div id="insert"></div>
		</div>
	</div>

	<div id="accordion2">
		<h3>messages</h3>
		<h3>logs</h3>
		<textarea id="log" rows="30" cols="120"></textarea>
		<!-- TODO - switch between html & text fromat (higher up - no span on text)
		   -->
		<!-- <div id="log"></div>  -->
	</div>

</body>
</html>
