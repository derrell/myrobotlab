<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>clock - Clock</title>
<link rel="stylesheet" href="../common/themes/vader/jquery-ui.css" />
<script src="../common/js/jquery-1.10.2.min.js"></script>
<script src="../common/js/jquery-ui.min.1.10.3.js"></script>
<script src="../common/js/jquery.websocket-0.0.1.js"></script>
<script
	src="http://jquery-json.googlecode.com/files/jquery.json-2.2.min.js"></script>
<script>
	// global registry and vars
	var registry = [];
	var webgui = new ClockWebGUI("clock");
	var ws; // the one and only websocket
	var debug = true;

	registry["clock"] = webgui;

	//-------Message begin---------
	// http://stackoverflow.com/questions/456177/function-overloading-in-javascript-best-practices
	function Message(name, method, params) {
		this.msgID = new Date().getTime();
		this.timeStamp = this.msgID;
		this.name = "";
		this.sender = "webgui";
		this.sendingMethod = "";
		this.historyList = new Array(); // necessary?
		this.method = "";
		this.data = new Array();
	}

	//-------Message end---------

	//-------ClockWebGUI begin---------
	function ClockWebGUI(name) {
		this.name = name;
	}

	ClockWebGUI.prototype.pulse = function(data) {
		$("#display").html(data);
	};

	ClockWebGUI.prototype.send = function(serviceName, method, data) {
		alert(serviceName + "." + method + "." + data);
	};
	//-------ClockWebGUI end---------

	// -- webgui framework display begin ---
	$(function() {
		$("#accordion").accordion({
			//collapsible: true,
			autoHeight : false,
			active : false
		});
	});
	// -- webgui framework display begin ---

	// -- websocket global connectivity and message processing begin --
	// TODO - jquery best practices - anonymous functions are to be avoided

	$(function() {
		$("#connect").button().click(function(event) {
			event.preventDefault();
			ws = new WebSocket("ws://localhost:7778");
			ws.open
			log("connecting");

			ws.onmessage = function(e) {
				log("Server: " + e.data);

				try {
					var msg = jQuery.parseJSON(e.data);
					log("invoke " + msg.sender + "." + msg.method);
					//this[msg.method].apply(this, Array.prototype.slice.call(msg.data, 1));
					// http://stackoverflow.com/questions/5112793/how-do-i-dynamically-call-a-javascript-objects-method
					//registry[msg.sender].apply(null, msg.method, msg.data)
					var ret = registry[msg.sender][msg.method](msg.data);
					//method.apply(null)
				} catch (err) {
					//alert("json parse error " + err + " data " + e.data); 
					log("json parse error " + err + " data " + e.data);
				}
			};
		});
	});

	$(function() {
		$("#send").button().click(function(event) {
			ws.send($("#message").val());
			event.preventDefault();
		});
	});

	// --- logging begin ----
	function error(text) {
		log("ERROR", text);
	}

	function debug(text) {
		log("DEBUG", text);
	}

	function info(text) {
		log("INFO", text);
	}

	function warn(text) {
		log("WARN", text);
	}

	function log(text) {
		$("#log").val((text !== null ? text : "null") + "\n" + $("#log").val());
		/*	
		$("#log").val(
				(new Date).getTime() + ": " + (text !== null ? text : "null")
						+ "\n" + $("#log").val());
		 */
	}
	// --- logging end ----

	$(document).ready(function() {
		$("#hide").click(function() {
			$("p").hide();
		});
		$("#show").click(function() {
			$("p").show();
		});

	});
</script>
<style>
#log
{
	font-family: monospace; 
	color: red;
}
</style>
</head>
<body>
	<div id="accordion">
		<h3>
			<img src="../Clock.png" />clock
		</h3>
		<div>
			<div id="display">10:34</div>
			<input id="message" type="text" />

			<button id="connect">connect</button>
			<button id="send">send</button>
			<button id="startClock">start clock</button>


			<textarea id="log" rows="30" cols="100"
				style="font-family: monospace; color: red;" ></textarea>
				 
		</div>
		<h3>
			<img src="../Runtime.png" />incubator
		</h3>
		<div>
			<p>Sed non urna. Donec et ante. Phasellus eu ligula. Vestibulum
				sit amet purus. Vivamus hendrerit, dolor at aliquet laoreet, mauris
				turpis porttitor velit, faucibus interdum tellus libero ac justo.
				Vivamus non quam. In suscipit faucibus urna.</p>
		</div>
	</div>
</body>
</html>
